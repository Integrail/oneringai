{"version":3,"sources":["../src/markdown/MarkmapRenderer.tsx"],"sourcesContent":["/**\n * Markmap Mindmap Renderer\n * Renders markdown content as an interactive mindmap.\n *\n * Requires `markmap-lib` and `markmap-view` as optional peer dependencies.\n */\n\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport { ZoomIn, ZoomOut, Maximize2 } from 'lucide-react';\nimport type { MarkmapRendererProps } from './types';\nimport { importOptional } from './importOptional';\n\nexport function MarkmapRenderer({\n  code,\n  onError,\n}: MarkmapRendererProps): React.ReactElement {\n  const svgRef = useRef<SVGSVGElement>(null);\n  const markmapRef = useRef<any>(null);\n  const [isRendered, setIsRendered] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const calculateHeight = useCallback((content: string): number => {\n    const lines = content.split('\\n').filter((line) => line.trim());\n    const depth = Math.max(\n      ...lines.map((line) => {\n        const match = line.match(/^(\\s*)/);\n        return match ? Math.floor(match[1].length / 2) : 0;\n      }),\n    );\n    return Math.max(300, Math.min(600, 200 + lines.length * 20 + depth * 40));\n  }, []);\n\n  useEffect(() => {\n    let mounted = true;\n\n    const renderMarkmap = async () => {\n      if (!svgRef.current || !code.trim()) return;\n\n      try {\n        // Dynamic imports â€” optional peer deps\n        const { Transformer } = await importOptional('markmap-lib');\n        const { Markmap, loadCSS, loadJS } = await importOptional('markmap-view');\n\n        const transformer = new Transformer();\n        const { root, features } = transformer.transform(code);\n        const { styles, scripts } = transformer.getUsedAssets(features);\n        if (styles) loadCSS(styles);\n        if (scripts) await loadJS(scripts, { getMarkmap: () => ({ Markmap }) });\n\n        if (!mounted) return;\n\n        if (markmapRef.current) {\n          markmapRef.current.destroy();\n        }\n\n        markmapRef.current = Markmap.create(svgRef.current, {\n          duration: 300,\n          fitRatio: 0.85,\n          spacingHorizontal: 80,\n          spacingVertical: 20,\n          autoFit: true,\n          initialExpandLevel: 3,\n          color: (node: any) => {\n            const colors = ['#5B8FF9', '#5AD8A6', '#F6BD16', '#E86452', '#6DC8EC', '#945FB9'];\n            return colors[(node.state?.depth || 0) % colors.length];\n          },\n        });\n\n        markmapRef.current.setData(root);\n        markmapRef.current.fit();\n        setIsRendered(true);\n        setError(null);\n      } catch (err) {\n        console.error('Markmap render error:', err);\n        const errorMsg = err instanceof Error ? err.message : 'Failed to render mindmap';\n        setError(errorMsg);\n        if (onError) onError(err instanceof Error ? err : new Error(errorMsg));\n      }\n    };\n\n    renderMarkmap();\n\n    return () => {\n      mounted = false;\n      if (markmapRef.current) {\n        markmapRef.current.destroy();\n        markmapRef.current = null;\n      }\n    };\n  }, [code, onError]);\n\n  const handleZoomIn = useCallback(() => {\n    if (markmapRef.current) {\n      const svg = markmapRef.current.svg;\n      const transform = svg.node()?.getAttribute('transform') || '';\n      const scaleMatch = transform.match(/scale\\(([\\d.]+)\\)/);\n      const currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;\n      markmapRef.current.rescale(Math.min(currentScale * 1.2, 3));\n    }\n  }, []);\n\n  const handleZoomOut = useCallback(() => {\n    if (markmapRef.current) {\n      const svg = markmapRef.current.svg;\n      const transform = svg.node()?.getAttribute('transform') || '';\n      const scaleMatch = transform.match(/scale\\(([\\d.]+)\\)/);\n      const currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;\n      markmapRef.current.rescale(Math.max(currentScale / 1.2, 0.3));\n    }\n  }, []);\n\n  const handleFit = useCallback(() => {\n    if (markmapRef.current) {\n      markmapRef.current.fit();\n    }\n  }, []);\n\n  if (error) {\n    return (\n      <div className=\"markmap-renderer markmap-renderer--error\">\n        <span className=\"markmap-renderer__error-text\">Error: {error}</span>\n      </div>\n    );\n  }\n\n  const height = calculateHeight(code);\n\n  return (\n    <div className=\"markmap-renderer\">\n      <div className=\"markmap-renderer__controls\">\n        <button className=\"markmap-renderer__btn\" onClick={handleZoomIn} title=\"Zoom In\">\n          <ZoomIn size={14} />\n        </button>\n        <button className=\"markmap-renderer__btn\" onClick={handleZoomOut} title=\"Zoom Out\">\n          <ZoomOut size={14} />\n        </button>\n        <button className=\"markmap-renderer__btn\" onClick={handleFit} title=\"Fit to View\">\n          <Maximize2 size={14} />\n        </button>\n      </div>\n      <svg\n        ref={svgRef}\n        className=\"markmap-renderer__svg\"\n        style={{ width: '100%', height: `${height}px` }}\n      />\n      {!isRendered && (\n        <div className=\"markmap-renderer__loading\">\n          <div className=\"rui-spinner\" role=\"status\">\n            <span className=\"rui-visually-hidden\">Rendering mindmap...</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default MarkmapRenderer;\n"],"mappings":"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","names":[]}