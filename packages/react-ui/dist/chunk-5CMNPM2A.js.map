{"version":3,"sources":["../src/markdown/MermaidDiagram.tsx"],"sourcesContent":["/**\n * Mermaid Diagram Renderer\n * Renders mermaid diagram code into SVG.\n *\n * Requires `mermaid` as an optional peer dependency.\n */\n\nimport React, { useEffect, useRef, useState, useId } from 'react';\nimport type { MermaidDiagramProps } from './types';\nimport { importOptional } from './importOptional';\n\nexport function MermaidDiagram({ code, onError }: MermaidDiagramProps): React.ReactElement {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [svg, setSvg] = useState<string | null>(null);\n  const [isRendering, setIsRendering] = useState(true);\n  const uniqueId = useId().replace(/:/g, '_');\n\n  useEffect(() => {\n    let mounted = true;\n\n    const renderDiagram = async () => {\n      if (!code.trim()) {\n        setIsRendering(false);\n        return;\n      }\n\n      try {\n        setIsRendering(true);\n\n        // Dynamic import â€” mermaid is an optional peer dep\n        const mermaid = (await importOptional('mermaid')).default;\n\n        mermaid.initialize({\n          startOnLoad: false,\n          theme: 'default',\n          securityLevel: 'loose',\n          fontFamily: 'inherit',\n          flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },\n          sequence: { useMaxWidth: true },\n          gantt: { useMaxWidth: true },\n        });\n\n        // Preprocess common issues\n        let processedCode = code.trim();\n        if (processedCode.startsWith('usecase')) {\n          processedCode = processedCode.replace(/^usecase/, 'flowchart TD');\n        }\n        processedCode = processedCode\n          .replace(/<br>/gi, '<br/>')\n          .replace(/\\s*<--\\s*/g, ' --> ');\n\n        const { svg: renderedSvg } = await mermaid.render(\n          `mermaid-${uniqueId}`,\n          processedCode,\n        );\n\n        if (mounted) {\n          setSvg(renderedSvg);\n          setIsRendering(false);\n        }\n      } catch (err) {\n        console.error('Mermaid render error:', err);\n        if (mounted) {\n          setIsRendering(false);\n          if (onError) {\n            onError(err instanceof Error ? err : new Error(String(err)));\n          }\n        }\n      }\n    };\n\n    renderDiagram();\n    return () => { mounted = false; };\n  }, [code, uniqueId, onError]);\n\n  if (isRendering) {\n    return (\n      <div className=\"mermaid-diagram mermaid-diagram--loading\">\n        <div className=\"rui-spinner\" role=\"status\">\n          <span className=\"rui-visually-hidden\">Rendering diagram...</span>\n        </div>\n      </div>\n    );\n  }\n\n  if (!svg) {\n    return (\n      <div className=\"mermaid-diagram mermaid-diagram--empty\">\n        <span>No diagram to render</span>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className=\"mermaid-diagram\"\n      dangerouslySetInnerHTML={{ __html: svg }}\n    />\n  );\n}\n\nexport default MermaidDiagram;\n"],"mappings":";;;;;AAOA,SAAgB,WAAW,QAAQ,UAAU,aAAa;AAwEhD;AApEH,SAAS,eAAe,EAAE,MAAM,QAAQ,GAA4C;AACzF,QAAM,eAAe,OAAuB,IAAI;AAChD,QAAM,CAAC,KAAK,MAAM,IAAI,SAAwB,IAAI;AAClD,QAAM,CAAC,aAAa,cAAc,IAAI,SAAS,IAAI;AACnD,QAAM,WAAW,MAAM,EAAE,QAAQ,MAAM,GAAG;AAE1C,YAAU,MAAM;AACd,QAAI,UAAU;AAEd,UAAM,gBAAgB,YAAY;AAChC,UAAI,CAAC,KAAK,KAAK,GAAG;AAChB,uBAAe,KAAK;AACpB;AAAA,MACF;AAEA,UAAI;AACF,uBAAe,IAAI;AAGnB,cAAM,WAAW,MAAM,eAAe,SAAS,GAAG;AAElD,gBAAQ,WAAW;AAAA,UACjB,aAAa;AAAA,UACb,OAAO;AAAA,UACP,eAAe;AAAA,UACf,YAAY;AAAA,UACZ,WAAW,EAAE,aAAa,MAAM,YAAY,MAAM,OAAO,QAAQ;AAAA,UACjE,UAAU,EAAE,aAAa,KAAK;AAAA,UAC9B,OAAO,EAAE,aAAa,KAAK;AAAA,QAC7B,CAAC;AAGD,YAAI,gBAAgB,KAAK,KAAK;AAC9B,YAAI,cAAc,WAAW,SAAS,GAAG;AACvC,0BAAgB,cAAc,QAAQ,YAAY,cAAc;AAAA,QAClE;AACA,wBAAgB,cACb,QAAQ,UAAU,OAAO,EACzB,QAAQ,cAAc,OAAO;AAEhC,cAAM,EAAE,KAAK,YAAY,IAAI,MAAM,QAAQ;AAAA,UACzC,WAAW,QAAQ;AAAA,UACnB;AAAA,QACF;AAEA,YAAI,SAAS;AACX,iBAAO,WAAW;AAClB,yBAAe,KAAK;AAAA,QACtB;AAAA,MACF,SAAS,KAAK;AACZ,gBAAQ,MAAM,yBAAyB,GAAG;AAC1C,YAAI,SAAS;AACX,yBAAe,KAAK;AACpB,cAAI,SAAS;AACX,oBAAQ,eAAe,QAAQ,MAAM,IAAI,MAAM,OAAO,GAAG,CAAC,CAAC;AAAA,UAC7D;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAEA,kBAAc;AACd,WAAO,MAAM;AAAE,gBAAU;AAAA,IAAO;AAAA,EAClC,GAAG,CAAC,MAAM,UAAU,OAAO,CAAC;AAE5B,MAAI,aAAa;AACf,WACE,oBAAC,SAAI,WAAU,4CACb,8BAAC,SAAI,WAAU,eAAc,MAAK,UAChC,8BAAC,UAAK,WAAU,uBAAsB,kCAAoB,GAC5D,GACF;AAAA,EAEJ;AAEA,MAAI,CAAC,KAAK;AACR,WACE,oBAAC,SAAI,WAAU,0CACb,8BAAC,UAAK,kCAAoB,GAC5B;AAAA,EAEJ;AAEA,SACE;AAAA,IAAC;AAAA;AAAA,MACC,KAAK;AAAA,MACL,WAAU;AAAA,MACV,yBAAyB,EAAE,QAAQ,IAAI;AAAA;AAAA,EACzC;AAEJ;AAEA,IAAO,yBAAQ;","names":[]}